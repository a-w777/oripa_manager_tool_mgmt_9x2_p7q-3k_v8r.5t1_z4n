<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒªãƒ‘ç®¡ç†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ Pro Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans JP', sans-serif;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">

    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin h-10 w-10 border-4 border-indigo-600 border-t-transparent rounded-full"></div>
            <p class="text-sm font-bold text-slate-600">ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...</p>
        </div>
    </div>

    <nav class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>â˜ï¸</span> ã‚ªãƒªãƒ‘ç®¡ç† Pro
            </h1>
            <div class="flex items-center gap-4">
                <span id="monthly_invested_header" class="text-xs bg-indigo-800 px-3 py-1.5 rounded-full">ä»Šæœˆã®æŠ•è³‡:
                    Â¥0</span>
                <span id="user_display" class="hidden md:block text-[10px] opacity-60">ID: ---</span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                <h2 class="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                    <span>ğŸ’³</span> ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ ç¾åœ¨ã®æ®‹é«˜
                </h2>
                <div id="service_balances" class="space-y-2 max-h-[250px] overflow-y-auto pr-2 text-sm"></div>
            </div>

            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-emerald-500">
                    <p class="text-xs text-slate-500 font-bold mb-1" id="label_monthly_cash">ä»Šæœˆã®æ”¯æ‰•é¡</p>
                    <h3 class="text-2xl font-bold" id="stat_monthly_cash">Â¥0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-amber-500">
                    <p class="text-xs text-slate-500 font-bold mb-1">ä»Šæœˆã®é«˜é¡å½“é¸</p>
                    <h3 class="text-2xl font-bold" id="stat_monthly_prizes">0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-indigo-500">
                    <p class="text-xs text-slate-500 font-bold mb-1">ç”Ÿæ¶¯ç·æŠ•è³‡é¡</p>
                    <h3 class="text-2xl font-bold" id="stat_total_cash">Â¥0</h3>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Form Area -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center justify-between">
                        <span id="form_title">ğŸ“¥ ä»Šæ—¥ã®è¨˜éŒ²</span>
                        <button id="cancelEdit" class="hidden text-xs text-red-500 hover:underline">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </h2>
                    <form id="recordForm" class="space-y-4">
                        <input type="hidden" id="editing_id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">ã‚µãƒ¼ãƒ“ã‚¹å</label>
                            <input type="text" id="serviceName" list="service_suggestions"
                                class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none"
                                required>
                            <datalist id="service_suggestions"></datalist>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">æ”¯æ‰•é‡‘é¡ (å††)</label>
                                <input type="number" id="cashAmount" value="0" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">ä»˜ä¸pts</label>
                                <input type="number" id="addedPoints" value="0" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">æ¶ˆè²»pts</label>
                                <input type="number" id="spentPoints" value="0" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">å½“é¸pts</label>
                                <input type="number" id="winPoints" value="0" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">é«˜é¡æ™¯å“</label>
                            <input type="text" id="highPrize" placeholder="ä¾‹: PSA10 ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³"
                                class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none">
                        </div>
                        <button type="submit" id="submitBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜</button>
                    </form>
                </div>
            </div>

            <!-- List Area -->
            <div class="lg:col-span-2 space-y-4">
                <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h2 class="font-bold text-slate-700">æœˆåˆ¥å±¥æ­´</h2>
                            <select id="monthFilter"
                                class="p-1.5 border rounded-lg text-sm bg-white outline-none"></select>
                        </div>
                        <button id="exportCsv"
                            class="text-xs border px-3 py-1.5 rounded bg-white hover:bg-slate-100 font-bold">CSVãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead
                                class="bg-slate-50 text-[10px] text-slate-400 font-black border-b uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">æ—¥ä»˜</th>
                                    <th class="p-4">ã‚µãƒ¼ãƒ“ã‚¹</th>
                                    <th class="p-4 text-center">æ”¯æ‰•é¡</th>
                                    <th class="p-4 text-center">Ptsæ¨ç§» / æ™¯å“</th>
                                    <th class="p-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oripa-pro-cloud-v4';

        let user = null;
        let records = [];

        // --- Core Logic ---

        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('user_display').innerText = `User: ${u.uid.substring(0, 8)}`;
                document.getElementById('user_display').classList.remove('hidden');
                startSync();
            }
        });

        function startSync() {
            if (!user) return;
            // RULE 1: Private user path
            const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'records');

            onSnapshot(colRef, (snapshot) => {
                records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => parseInt(b.id) - parseInt(a.id));

                setupMonthFilter();
                renderUI();
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, (err) => {
                console.error("Firestore Error:", err);
            });
        }

        async function saveRecord(e) {
            e.preventDefault();
            if (!user) return;

            const editId = document.getElementById('editing_id').value;
            const docId = editId || `${Date.now()}`;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'records', docId);

            const data = {
                date: editId ? records.find(r => r.id === editId).date : new Date().toLocaleDateString('ja-JP'),
                service: document.getElementById('serviceName').value.trim(),
                cash: parseInt(document.getElementById('cashAmount').value) || 0,
                added: parseInt(document.getElementById('addedPoints').value) || 0,
                spent: parseInt(document.getElementById('spentPoints').value) || 0,
                won: parseInt(document.getElementById('winPoints').value) || 0,
                prize: document.getElementById('highPrize').value.trim(),
                updatedAt: new Date().toISOString()
            };

            try {
                await setDoc(docRef, data, { merge: true });
                resetForm();
            } catch (err) {
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        window.deleteRecord = async (id) => {
            if (!user || !confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'records', String(id));
            await deleteDoc(docRef);
        };

        window.editRecord = (id) => {
            const r = records.find(rec => rec.id == id);
            if (!r) return;
            document.getElementById('editing_id').value = r.id;
            document.getElementById('serviceName').value = r.service;
            document.getElementById('cashAmount').value = r.cash;
            document.getElementById('addedPoints').value = r.added;
            document.getElementById('spentPoints').value = r.spent;
            document.getElementById('winPoints').value = r.won;
            document.getElementById('highPrize').value = r.prize;
            document.getElementById('submitBtn').innerText = "ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£";
            document.getElementById('form_title').innerText = "âœï¸ è¨˜éŒ²ã®ç·¨é›†";
            document.getElementById('cancelEdit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function resetForm() {
            document.getElementById('recordForm').reset();
            document.getElementById('editing_id').value = "";
            document.getElementById('submitBtn').innerText = "ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜";
            document.getElementById('form_title').innerText = "ğŸ“¥ ä»Šæ—¥ã®è¨˜éŒ²";
            document.getElementById('cancelEdit').classList.add('hidden');
        }

        function setupMonthFilter() {
            const months = new Set();
            const now = new Date();
            const currentM = `${now.getFullYear()}/${now.getMonth() + 1}`;
            months.add(currentM);
            records.forEach(r => {
                const parts = r.date.split('/');
                months.add(`${parts[0]}/${parseInt(parts[1])}`);
            });
            const filter = document.getElementById('monthFilter');
            const oldVal = filter.value;
            filter.innerHTML = Array.from(months).sort().reverse().map(m => `<option value="${m}">${m.split('/')[0]}å¹´ ${m.split('/')[1]}æœˆ</option>`).join('');
            filter.value = oldVal || currentM;
        }

        function renderUI() {
            const filter = document.getElementById('monthFilter');
            const selectedMonth = filter.value;
            const balances = {};
            let totalLifetimeCash = 0;
            let monthlyCash = 0;
            let monthlyPrizes = 0;
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}/${now.getMonth() + 1}`;

            records.forEach(r => {
                if (!balances[r.service]) balances[r.service] = 0;
                balances[r.service] += (r.added + r.won - r.spent);
                totalLifetimeCash += r.cash;
            });

            const filtered = records.filter(r => {
                const parts = r.date.split('/');
                const rMonth = `${parts[0]}/${parseInt(parts[1])}`;
                if (rMonth === selectedMonth) {
                    monthlyCash += r.cash;
                    if (r.prize) monthlyPrizes++;
                    return true;
                }
                return false;
            });

            const currentMonthInvested = records.reduce((acc, r) => {
                const parts = r.date.split('/');
                return (`${parts[0]}/${parseInt(parts[1])}` === currentMonthStr) ? acc + r.cash : acc;
            }, 0);

            // Update DOM
            document.getElementById('stat_monthly_cash').innerText = `Â¥${monthlyCash.toLocaleString()}`;
            document.getElementById('stat_monthly_prizes').innerText = monthlyPrizes;
            document.getElementById('stat_total_cash').innerText = `Â¥${totalLifetimeCash.toLocaleString()}`;
            document.getElementById('monthly_invested_header').innerText = `ä»Šæœˆã®æŠ•è³‡: Â¥${currentMonthInvested.toLocaleString()}`;
            document.getElementById('label_monthly_cash').innerText = `${selectedMonth.split('/')[1]}æœˆã®æ”¯æ‰•é¡`;

            document.getElementById('historyBody').innerHTML = filtered.map(r => {
                const net = (r.added + r.won) - r.spent;
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 text-[10px] text-slate-400 font-mono">${r.date}</td>
                        <td class="p-4 font-bold text-slate-700">${r.service}</td>
                        <td class="p-4 text-center text-rose-500 font-bold">Â¥${r.cash.toLocaleString()}</td>
                        <td class="p-4 text-center">
                            <div class="text-[10px] font-bold ${net >= 0 ? 'text-emerald-600' : 'text-slate-400'}">å·®å¼•: ${net > 0 ? '+' : ''}${net.toLocaleString()} pts</div>
                            <div class="text-[10px] ${r.prize ? 'text-amber-600 font-bold bg-amber-50 rounded px-1' : 'text-slate-300'}">${r.prize || '---'}</div>
                        </td>
                        <td class="p-4 text-right space-x-3">
                            <button onclick="editRecord('${r.id}')" class="text-indigo-500 hover:text-indigo-700">ä¿®æ­£</button>
                            <button onclick="deleteRecord('${r.id}')" class="text-slate-300 hover:text-red-500 font-bold">Ã—</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('service_balances').innerHTML = Object.entries(balances).sort((a, b) => b[1] - a[1]).map(([n, b]) => `
                <div class="flex justify-between items-center bg-slate-50 p-2.5 rounded-lg border border-slate-100 mb-1">
                    <span class="font-bold text-slate-600">${n}</span>
                    <span class="font-mono text-indigo-600 font-bold">${b.toLocaleString()} pts</span>
                </div>
            `).join('');

            document.getElementById('service_suggestions').innerHTML = Object.keys(balances).map(n => `<option value="${n}">`).join('');
        }

        // Event Listeners
        document.getElementById('recordForm').addEventListener('submit', saveRecord);
        document.getElementById('cancelEdit').addEventListener('click', resetForm);
        document.getElementById('monthFilter').addEventListener('change', renderUI);
        document.getElementById('exportCsv').addEventListener('click', () => {
            if (records.length === 0) return;
            let csv = "æ—¥ä»˜,ã‚µãƒ¼ãƒ“ã‚¹,æ”¯æ‰•é‡‘é¡,ä»˜ä¸Pts,æ¶ˆè²»Pts,å½“é¸Pts,æ™¯å“\n";
            records.forEach(r => csv += `"${r.date}","${r.service}",${r.cash},${r.added},${r.spent},${r.won},"${r.prize}"\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv' });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `oripa_backup_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        init();
    </script>
</body>

</html>